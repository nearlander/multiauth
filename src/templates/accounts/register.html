{% extends '../base.html' %}
{% block title %}Register{% endblock %}

{% block head %}
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

body {
    font-family: 'Poppins', sans-serif;
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    background: linear-gradient(135deg, #f0f4f8, #e0e7ff);
    color: #111;
}

/* Landing Section */
.landing-section {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    position: relative;
}

/* Card container */
.landing-card {
    position: relative;
    width: 100%;
    max-width: 1200px;
    background: rgba(255,255,255,0.95);
    border-radius: 2rem;
    padding: 3rem 4rem;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 3rem;
    align-items: start;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
}

@media (max-width: 1024px) { .landing-card { grid-template-columns: 1fr; padding: 2rem; } }

/* Headings */
.landing-card h2 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 2rem;
    color: #111;
    text-shadow: none; /* removed glow */
}

/* Labels style */
.landing-card label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    font-size: 0.95rem;
    color: #374151; /* subtle dark gray */
    text-transform: uppercase;
    letter-spacing: 0.03em;
}

/* Form inputs */
.landing-card input, .landing-card select {
    width: 100%;
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    border-radius: 0.75rem;
    border: 1px solid rgba(0,0,0,0.1);
    background: #fff;
    color: #111;
    outline: none;
    transition: all 0.3s ease;
}

.landing-card input:focus, .landing-card select:focus {
    border-color: #3b82f6;
    box-shadow: 0 0 10px rgba(59,130,246,0.3);
}

/* Webcam card */
.camera-card {
    background: #f9fafb;
    border: 2px solid #3b82f6;
    border-radius: 1.5rem;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 20px rgba(59,130,246,0.3);
}

.camera-card video {
    border-radius: 1rem;
    border: 2px solid #3b82f6;
    max-width: 100%;
}

/* Buttons */
#captureBtn, #registerSubmit {
    padding: 1rem 2rem;
    font-weight: 600;
    border-radius: 50px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
}

#captureBtn {
    background: linear-gradient(135deg, #10b981, #06b6d4);
    color: #fff;
    margin-top: 1rem;
    box-shadow: 0 0 10px #10b981, 0 0 20px #06b6d4;
}

#captureBtn:hover { transform: translateY(-2px) scale(1.03); }

#registerSubmit {
    background: linear-gradient(135deg, #3b82f6, #9333ea);
    color: #fff;
    margin-top: 2rem;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 0 10px #3b82f6, 0 0 20px #9333ea;
}

/* Webcam preview */
#preview {
    margin-top: 1rem;
    border-radius: 1rem;
    box-shadow: 0 0 15px rgba(59,130,246,0.3);
    animation: float 6s ease-in-out infinite;
}

@keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

/* Animated messages */
.message-box {
    position: absolute;
    top: 1rem;
    left: 50%;
    transform: translateX(-50%);
    padding: 1rem 2rem;
    border-radius: 1rem;
    font-weight: 600;
    text-align: center;
    opacity: 0;
    pointer-events: none;
    transition: all 0.5s ease;
    z-index: 20;
    font-size: 0.95rem;
}

.message-success { background: #10b981; color: #fff; }
.message-error { background: #ef4444; color: #fff; }

.message-box.show { opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }
</style>
{% endblock %}

{% block content %}
<section class="landing-section">
  <div class="landing-card">
    <!-- Form -->
    <div>
      <h2>Create New Account</h2>

      <div id="msgBox" class="message-box"></div>

      <form method="POST" enctype="multipart/form-data" action="{% url 'accounts:register' %}">
        {% csrf_token %}
        <div class="grid gap-4 sm:grid-cols-2 sm:gap-4">
          <div class="w-full"><label>First Name</label>{{ form.first_name }}</div>
          <div class="w-full"><label>Last Name</label>{{ form.last_name }}</div>
          <div class="sm:col-span-2"><label>Username</label>{{ form.username }}</div>
          <div class="sm:col-span-2"><label>Email</label>{{ form.email }}</div>
          <div><label>Password</label>{{ form.password1 }}</div>
          <div><label>Confirm Password</label>{{ form.password2 }}</div>
          <div class="w-full"><label>Phone Number</label>{{ form.phone_number }}</div>
          <div><label>Gender</label>{{ form.gender }}</div>
        </div>

        <div class="w-full text-center mt-6">
          <button type="submit" id="registerSubmit">Register</button>
        </div>
      </form>
    </div>

    <!-- Camera -->
    <div class="camera-card">
      <h3 class="mb-3 font-semibold">Capture Your Face</h3>
      <video id="camera" width="320" height="240" autoplay playsinline muted></video>
      <canvas id="snapshot" width="320" height="240" style="display:none;"></canvas>
      <img id="preview" alt="" style="display:none;width:160px;height:auto;" />
      <input type="hidden" name="captured_image" id="capturedImageInput" />
      <button type="button" id="captureBtn">Capture Face</button>
      <p class="text-sm mt-2">After capturing, click Register.</p>
    </div>
  </div>
</section>

<script>
const video = document.getElementById('camera');
const canvas = document.getElementById('snapshot');
const ctx = canvas.getContext('2d');
const captureBtn = document.getElementById('captureBtn');
const capturedImageInput = document.getElementById('capturedImageInput');
const preview = document.getElementById('preview');
const msgBox = document.getElementById('msgBox');

navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => { video.srcObject = stream; })
  .catch(err => { showMessage('Camera permission denied', 'error'); });

captureBtn.addEventListener('click', () => {
  if (!video.srcObject) return showMessage('No camera detected', 'error');

  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const imageData = canvas.toDataURL('image/png');

  if (!imageData || !imageData.startsWith('data:image/')) {
      showMessage('Face not detected. Try again.', 'error');
      return;
  }

  capturedImageInput.value = imageData;
  preview.src = imageData;
  preview.style.display = 'block';
  showMessage('Face captured successfully!', 'success');
});

document.querySelector('form').addEventListener('submit', (e) => {
  if (!capturedImageInput.value || !capturedImageInput.value.startsWith('data:image/')) {
    e.preventDefault();
    showMessage('Please capture your face before submitting.', 'error');
  }
});

function showMessage(text, type) {
    msgBox.textContent = text;
    msgBox.className = 'message-box show ' + (type === 'success' ? 'message-success' : 'message-error');
    setTimeout(() => { msgBox.className = 'message-box'; }, 3500);
}
</script>
{% endblock %}
