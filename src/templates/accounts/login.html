{% extends "../base.html" %}
{% load static %}
{% block title %}Login{% endblock %}

{% block content %}
<section class="bg-white dark:bg-gray-900">
  <div class="grid max-w-screen-xl px-4 py-8 mx-auto lg:gap-8 xl:gap-0 lg:py-16 lg:grid-cols-12">
    <div class="mr-auto place-self-center lg:col-span-7">
      <div class="mb-10">
        <h1 class="max-w-2xl mb-4 text-4xl font-extrabold tracking-tight leading-none md:text-5xl xl:text-6xl dark:text-white">
          Welcome Back, Login And Let's Go!
        </h1>
      </div>

      <!-- Hidden webcam capture form -->
      <form method="POST" action="{% url 'accounts:login_face' %}">
        {% csrf_token %}
        <input type="hidden" name="captured_image" id="loginCapturedImageInput">
        <button type="button" id="loginCaptureBtn" 
          class="mt-3 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
          Login with Face
        </button>
      </form>

    </div>

    <div class="hidden lg:mt-0 lg:col-span-5 lg:flex">
      <img src="{% static "icons/3562336.png" %}" alt="mockup">
    </div>                
  </div>
</section>

<!-- JavaScript for silent webcam capture -->
<script>
const captureBtn = document.getElementById('loginCaptureBtn');
const capturedInput = document.getElementById('loginCapturedImageInput');

captureBtn.addEventListener('click', async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    const track = stream.getVideoTracks()[0];
    const imageCapture = new ImageCapture(track);
    const bitmap = await imageCapture.grabFrame();

    const canvas = document.createElement('canvas');
    canvas.width = bitmap.width;
    canvas.height = bitmap.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(bitmap, 0, 0);

    capturedInput.value = canvas.toDataURL('image/png');
    
    // Stop the webcam immediately
    track.stop();

    // Submit the form
    captureBtn.closest('form').submit();
  } catch (err) {
    alert('Camera access failed: ' + err.message);
  }
});
</script>
{% endblock %}
